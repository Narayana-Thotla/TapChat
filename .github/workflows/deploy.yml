name: Production deployment of Tapchat

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'

jobs:
  deploy:
    name: Deploy to production server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
       
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Debug SSH connection
        run: ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} "echo connected successfully"

      - name: Deploy to ${{ github.event.inputs.environment }}
        env:
          ENVIRONMENT: production
          EC2_HOST: ${{ secrets.EC2_HOST }}
          MONGO_URI: ${{ secrets.MONGO_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          PASSWORD: ${{ secrets.PASSWORD }}
          PORT: ${{ secrets.PORT }}

        run: |
          echo "ðŸ“¦ Creating folder on EC2..."
          ssh -o StrictHostKeyChecking=no ec2-user@${{ env.EC2_HOST }} "mkdir -p /home/ec2-user/tapchat-app"

          echo "ðŸ“¦ Uploading project files..."
          scp -o StrictHostKeyChecking=no -r . ec2-user@${{ env.EC2_HOST }}:/home/ec2-user/tapchat-app

          echo "ðŸš€ Running deployment on EC2..."
          ssh -o StrictHostKeyChecking=no ec2-user@${{ env.EC2_HOST }} << 'EOF'
            cd /home/ec2-user/tapchat-app

            echo "mongodb=${{ env.MONGO_URI }}" > .env
            echo "cookieToken=${{ env.JWT_SECRET }}" >> .env
            echo "password=${{ env.PASSWORD }}" >> .env
            echo "port=${{ env.PORT }}" >> .env

            # Clean and rebuild on the server itself
            npm ci
            npm run build

            echo "âœ… Deployment completed successfully!!"
          EOF